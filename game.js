function fontDrawer(a){return{img:a,letters:function(){for(var a=[],d=0;26>d;d++)a.push(String.fromCharCode(97+d)),a.push(String.fromCharCode(65+d));for(d=0;10>d;d++)a.push(String.fromCharCode(48+d));return a}(),draw:function(a,d,c,e,g){a.save();g&&a.scale(g,g);for(g=0;g<d.length;g++){var h=a,l=d[g],k=6*g+c,n=e;-1!==this.letters.indexOf(l)&&(l=l.toUpperCase().charCodeAt(0),h.drawImage(this.img,5*(64<l?l-65:l-48),5*(64<l?0:1),5,5,k,n,5,5))}a.restore()},drawIcon:function(a,d,c,e){(d={">":12,"<":0,on:11,
off:10}[d])&&a.drawImage(this.img,5*d,5,5,5,c,e,5,5)}}};function Images(){return{images:{},load:function(a){var b=["alphabet","pixrl1"],d=0,c=this;b.forEach(function(e){var g=new Image;g.src=e+".png";g.addEventListener("load",function(){d++;d===b.length&&a(c.images)});this.images[e]=g},this)}}};function renderMap(a,b,d){var c=this.game.getPixelSize(),e=this.fontdrawer;iter2dArray(b.map,function(g,h,l){var k=h*c,n=l*c;h=b.isSolid(h,l);d?"100"===g?(a.fillStyle="gray",a.fillRect(k,n,c,c),e.drawIcon(a,"on",k+4|0,n+5|0),g=[255,255,0],a.strokeStyle="rgba("+g[0]+","+g[1]+","+g[2]+",0.8)",a.strokeRect(k,n,c,c)):"30"===g?(a.strokeStyle="yellow",a.strokeRect(k,n,c,c)):"20"===g?(a.fillStyle="red",a.fillRect(k,n,c,c)):"99"===g?(a.save(),a.shadowBlur=25,a.shadowColor="white",g=a.createLinearGradient(0,
0,0,n+20),g.addColorStop(0,"white"),g.addColorStop(1,"black"),a.fillStyle=g,a.fillRect(k,n,c,c),a.restore()):h?(e.draw(a,g,k+5|0,n+5|0),a.strokeStyle="green",a.strokeRect(k,n,c,c)):(g=.3<Math.random()?g:randomLetter(),e.draw(a,g,k+5|0,n+5|0)):(a.fillStyle="blue",h&&a.fillRect(k,n,c,c))})}function iter2dArray(a,b){for(var d=0;d<a.length;d++)for(var c=0;c<a[0].length;c++)b(a[d][c],c,d)};function renderSprites(){this.img=new Image;this.img.src="pixlr1.png"};var Stats=function(){function a(a){c.appendChild(a.dom);return a}function b(a){for(var b=0;b<c.children.length;b++)c.children[b].style.display=b===a?"block":"none";d=a}var d=0,c=document.createElement("div");c.style.cssText="position:fixed;top:0;left:0;cursor:pointer;opacity:0.9;z-index:10000";c.addEventListener("click",function(a){a.preventDefault();b(++d%c.children.length)},!1);var e=(performance||Date).now(),g=e,h=0,l=a(new Stats.Panel("FPS","#0ff","#002")),k=a(new Stats.Panel("MS","#0f0","#020"));
if(self.performance&&self.performance.memory)var n=a(new Stats.Panel("MB","#f08","#201"));b(0);return{REVISION:16,dom:c,addPanel:a,showPanel:b,begin:function(){e=(performance||Date).now()},end:function(){h++;var a=(performance||Date).now();k.update(a-e,200);if(a>g+1E3&&(l.update(1E3*h/(a-g),100),g=a,h=0,n)){var b=performance.memory;n.update(b.usedJSHeapSize/1048576,b.jsHeapSizeLimit/1048576)}return a},update:function(){e=this.end()},domElement:c,setMode:b}};
Stats.Panel=function(a,b,d){var c=Infinity,e=0,g=Math.round,h=g(window.devicePixelRatio||1),l=80*h,k=48*h,n=3*h,v=2*h,q=3*h,p=15*h,r=74*h,t=30*h,u=document.createElement("canvas");u.width=l;u.height=k;u.style.cssText="width:80px;height:48px";var m=u.getContext("2d");m.font="bold "+9*h+"px Helvetica,Arial,sans-serif";m.textBaseline="top";m.fillStyle=d;m.fillRect(0,0,l,k);m.fillStyle=b;m.fillText(a,n,v);m.fillRect(q,p,r,t);m.fillStyle=d;m.globalAlpha=.9;m.fillRect(q,p,r,t);return{dom:u,update:function(k,
w){c=Math.min(c,k);e=Math.max(e,k);m.fillStyle=d;m.globalAlpha=1;m.fillRect(0,0,l,p);m.fillStyle=b;m.fillText(g(k)+" "+a+" ("+g(c)+"-"+g(e)+")",n,v);m.drawImage(u,q+h,p,r-h,t,q,p,r-h,t);m.fillRect(q+r-h,p,h,t);m.fillStyle=d;m.globalAlpha=.9;m.fillRect(q+r-h,p,h,g((1-k/w)*t))}}};"object"===typeof module&&(module.exports=Stats);function randi(a){a=a||100;return Math.floor(randd()*a)}function randd(){return Math.random()};function getMaps(){var a=0,b=0,d=[function(){return{maps:[[[1,0,0,0,0,0,0,0,0,0,0,0,0,0],[1,0,0,0,0,0,0,0,0,0,0,0,0,0],[1,0,99,0,0,0,0,0,0,0,0,0,100,0],[1,30,20,2,2,3,4,15,2,2,2,2,2,2],[1,0,0,0,0,0,0,0,0,0,0,0,0,0],[1,0,0,0,0,0,0,0,0,0,0,0,0,0],[1,0,0,0,0,0,0,0,0,0,0,0,0,0],[1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0],[1,0,0,0,0,0,0,0,0,0,0,0,0,0],[1,0,0,0,0,0,0,0,0,0,0,0,0,0],[1,0,0,99,0,0,0,0,0,0,0,0,0,0],[1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0]],[[1,0,0,0,0,0,
0,0,0,0,0,0,0,0],[1,0,0,0,0,0,0,0,0,0,0,0,0,0],[1,0,0,0,0,0,0,0,0,0,0,0,100,0],[1,0,1,1,1,1,1,1,1,1,1,1,1,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0],[1,0,0,0,0,0,0,0,0,0,0,0,0,0],[1,0,0,0,0,0,0,0,0,0,0,0,0,0],[1,1,1,1,1,1,1,1,1,1,1,1,0,0],[1,0,0,0,0,0,0,0,0,0,0,0,0,0],[1,0,0,0,0,0,0,0,0,0,0,0,99,0],[1,0,0,0,0,0,0,0,0,0,0,0,0,0],[1,0,0,99,0,0,0,0,0,0,0,0,0,0],[1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0]]],sprites:[{x:50,y:50},{x:110,y:10}],start:[90,20]}},function(){return{maps:[[[1,0,0,0,0,0,
0,0,0,0,0,0,0,0],[1,0,0,2,0,0,0,2,0,0,0,0,0,0],[1,0,0,2,0,0,0,8,0,0,0,0,0,0],[1,0,0,2,0,0,0,7,0,0,0,0,0,0],[1,0,0,2,0,0,0,6,0,0,0,0,0,0],[1,0,0,3,0,0,0,5,0,0,0,0,0,0],[1,0,0,4,100,0,0,4,0,0,0,0,0],[1,0,0,1,1,1,1,1,1,1,0,0,0,1],[1,0,0,12,0,0,0,0,0,0,0,0,0,0],[1,0,0,2,0,0,0,0,0,0,0,99,0,0],[1,0,0,4,0,0,0,0,1,1,1,1,1,1],[1,0,0,5,0,0,0,0,0,0,0,0,0,0],[1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0]],[[1,0,0,0,0,0,0,0,0,0,0,0,0,0],[1,4,0,2,0,0,0,0,2,0,0,0,0,0],[1,0,0,2,0,0,0,0,8,0,0,0,0,0],
[1,0,2,2,0,0,0,0,7,0,0,0,0,0],[1,0,0,2,0,0,0,0,6,0,0,0,0,0],[1,0,0,3,0,0,0,0,0,0,0,0,0,0],[1,0,0,4,0,0,0,0,0,0,0,100,0,0],[1,0,0,1,1,1,1,1,1,1,1,1,1,1],[1,0,0,12,0,0,0,0,0,0,0,0,0,0],[1,0,0,2,0,0,0,0,0,0,0,99,0,0],[1,0,0,4,0,0,0,0,1,1,1,1,1,1],[1,0,0,5,0,0,0,0,0,0,0,0,0,0],[1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0]]],start:[80,20],sprites:[{x:116,y:80},{x:143,y:119}]}},function(){return{maps:[[[1,0,0,0,0,0,0,0,0,0,0,0,0,0],[1,0,0,0,0,0,0,2,0,0,0,0,0,0],[1,2,2,2,0,0,0,8,0,0,0,0,0,
0],[1,0,0,2,0,0,0,7,0,0,0,0,0,0],[1,0,0,2,0,0,0,6,0,0,0,0,0,0],[1,0,0,3,0,0,0,5,0,0,0,0,0,0],[1,0,0,4,100,0,0,4,0,0,0,0,0],[1,0,0,1,1,1,1,1,1,1,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0],[1,5,5,2,0,0,0,0,0,0,0,99,0,0],[1,0,0,4,0,0,0,0,1,1,1,1,1,1],[1,0,0,5,0,0,0,0,0,0,0,0,0,0],[1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0]],[[1,0,0,0,0,0,0,0,0,0,0,0,0,0],[1,0,0,0,0,0,0,2,0,0,0,0,0,0],[1,0,0,0,0,0,0,8,0,0,0,0,0,0],[1,0,0,0,0,0,0,7,0,0,0,0,0,0],[1,0,0,0,0,0,0,6,0,0,0,0,0,0],[1,100,0,3,0,0,
0,5,0,0,0,0,0,0],[1,1,1,4,100,0,0,4,0,0,0,0,0],[1,0,0,1,1,1,1,1,1,1,0,0,0,1],[1,0,0,12,0,0,0,0,0,0,0,0,0,0],[1,0,0,2,0,0,0,0,0,0,0,99,0,0],[1,0,0,4,0,0,0,0,1,1,1,1,1,1],[1,99,0,5,0,0,0,0,0,0,0,0,0,0],[1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0]]],start:[80,20],sprites:[{x:112,y:119}]}},function(){return{maps:[[[1,0,0,0,0,0,0,0,0,0,0,0,0,0],[1,0,0,0,0,0,0,0,0,0,0,0,0,0],[1,0,0,0,0,0,0,0,0,0,0,0,0,0],[1,0,0,0,0,0,0,0,0,0,0,0,0,0],[1,0,0,0,0,0,0,0,0,0,0,0,0,0],[1,0,0,0,0,0,0,0,0,0,0,0,
0,0],[1,0,0,0,0,0,0,0,0,0,0,0,0,0],[1,0,0,0,0,0,0,0,0,0,0,0,0,0],[1,0,0,0,0,0,0,0,1,0,0,0,0,0],[1,0,0,0,0,0,0,0,1,0,0,0,0,0],[1,0,15,1,1,0,0,0,1,0,0,0,0,0],[1,0,11,0,0,0,0,1,1,1,1,1,1,0],[1,0,11,0,0,0,0,0,0,0,0,0,0,0],[1,1,1,1,1,1,1,1,1,1,1,1,1,1]]],start:[80,20],sprites:[]}}];return{nextLevel:function(b){b=this.restartMap(b);a++;return b},restartMap:function(b){var e=(0,d[a])();this.start=e.start;this.maps=e.maps.map(function(a){var d=new World(resolution);d.init(a,b);return d},this);return{map:this.maps[0],
start:e.start,sprites:e.sprites}},nextMap:function(){b=(b+1)%this.maps.length;return this.maps[b]},maps:[]}};var GameScene=function(a,b){this.sprites=b;this.name="gamescene";this.isGravity=!0;this.player=new Player(90,20);this.glitchMode=!0;this.game=a;this.fontdrawer=a.fontdrawer;b.push(this.player);this.maps=getMaps();this.resetLevel(this.maps.restartMap());this.playerSprite=a.images.pixrl1;this.restarting=!1;this.restartCounter=0;this.rTime=200;this.arrow={}};
GameScene.prototype={update:function(a){var b=this.player;this.restarting?(this.restartCounter--,0>this.restartCounter&&(this.restarting=!1,this.resetLevel(this.maps.restartMap()))):(this.sprites.forEach(function(a){"player"!==a.type&&(a.move(this.map),"sprite"===a.type&&a.x<b.x+b.width&&a.x+a.width>b.x&&a.y<b.y+b.height&&a.y+a.height>b.y&&(console.log("dead"),this.restart()))},this),this.getPressedKeys(a),this.movePlayer(),a=this.map.getTile(b.x,b.y),"100"===a.t||"99"===a.t?(this.arrow=this.arrow?
this.arrow:new Arrow(a.x,a.y),this.arrow.move()):this.arrow=null)},nextLevel:function(){var a=this.maps.nextLevel();this.resetLevel(a)},resetLevel:function(a){this.sprites=[this.player];this.map=a.map;a.start&&(this.player.x=a.start[0],this.player.y=a.start[1]);a.sprites&&a.sprites.forEach(function(a){a=new Sprite(a.x,a.y);a.vx=a.speed;a.vy=.5;this.sprites.push(a)},this);this.player.isOnGround=!1},render:function(a){a.globalAlpha=0<this.restartCounter?this.restartCounter/this.rTime:1;renderMap.call(this,
a,this.map,this.glitchMode);this.sprites.forEach(function(b){a.fillStyle=b.col||"green";a.fillRect(b.x,b.y,b.width,b.height);a.drawImage(this.game.images.pixrl1,b.img,0,16,16,b.x-5,b.y-5,16,16)},this);if(this.arrow){var b=this.arrow.x,d=this.arrow.y+this.arrow.vy;a.save();a.translate(b,d-10);a.rotate(Math.PI/180*-90);a.translate(-b-5,-d+10);a.font="10px Arial";a.fillText("\u2794",b,d);a.restore()}this.map.collisionTiles.forEach(function(b){var d=this.game.getPixelSize();a.fillStyle="gray";a.fillRect(b.x*
d,b.y*d,d,d)},this);this.map.collisionTiles=[];0<this.restartCounter&&this.restartCounter<this.rTime/2&&(a.globalAlpha=1,this.fontdrawer.draw(a,"0",20,20,2),this.fontdrawer.draw(a,"x",50,45),this.fontdrawer.draw(a,"DEAD",30,20,2))},getPressedKeys:function(a){var b=this.player;a.pressed[a.A]&&!b.jumping&&b.isOnGround&&(b.vy=-6,b.jumping=!0,b.isOnGround=!1,b.canJump=!1);a.pressed[a.DOWN]&&(b.vy=1);a.pressed[a.LEFT]&&(b.vx=-1);a.released[a.LEFT]&&(b.vx=0);a.pressed[a.RIGHT]&&(b.vx=1);a.pressed[a.F]&&
(this.glitchMode=!this.glitchMode);a.released[a.UP]&&(b=this.map.getTile(b.x+b.width/2,b.y+b.height/2).t,"100"===b&&(console.log("switch pressed"),this.map=this.maps.nextMap()),"99"===b&&(console.log("end of level"),this.nextLevel()),a.released[a.UP]=!1)},restart:function(){this.restarting=!0;this.restartCounter=this.rTime},movePlayer:function(){var a=this.player,b=this.map,d=a.vx,c=a.vy,c=c+.5;if(0<d){d-=.1;.05>d&&(d=0);var e=a.x+d+a.width,g=a.y,h=a.y+a.height,g=b.collidingPoint(e,g),l=b.collidingPoint(e,
h);if(g||l)d=0}else 0>d&&(e=a.x+d,g=a.y,h=a.y+a.height,g=b.collidingPoint(e,g),l=b.collidingPoint(e,h),g||l)&&(d=0);if(0<c){1<c&&(c=1);var e=a.y+c+a.height,k=a.x,h=a.x+a.width,g=b.collidingPoint(k,e),l=b.collidingPoint(h,e);if(g||l)c=b.getTile(k,e).t,b=b.getTile(h,e).t,a.jumping=!1,a.isOnGround=!0,a.canJump=!0,"20"!==c&&"20"!==b||console.log("0xDEAD"),c=0}else 0>c&&(e=a.y+c,k=a.x,h=a.x+a.width,g=b.collidingPoint(k,e),l=b.collidingPoint(h,e),g||l)&&(c=0);a.vy=c;a.vx=d;a.x+=a.vx;a.y+=a.vy}};function TitleScene(a){this.g=a}TitleScene.prototype={update:function(a){a.anyPressed()&&this.g.nextScene()},render:function(a){var b=this.g.fontdrawer;b.draw(a,"RPGlitch",10,10,2);b.draw(a,"Controls : ",50,50);b.draw(a,"Arrows to move,",50,60);b.draw(a,"A to open doors",50,70);b.draw(a,"and press switches",50,80)}};var canvasScaleFactor=3,resolution=180,Game={delta:0,then:0,logInfo:[],canvasSize:resolution,glitchMode:!0,isGravity:!0,images:{},init:function(a,b){var d=this.canvasSize*canvasScaleFactor,c=this.canvas=document.getElementById("canvas");this.ctx=c.getContext("2d");c.width=d;c.height=d;this.sprites=[];this.ctx.scale(canvasScaleFactor,canvasScaleFactor);this.ctx.imageSmoothingEnabled=!1;this.ctx.mozImageSmoothingEnabled=!1;this.keys=KeyListeners();this.images=b;this.scene1=new TitleScene(this);this.fontdrawer=
fontDrawer(b.alphabet)},getPixelSize:function(){return this.canvasSize/this.scene1.map.size},render:function(){var a=this.ctx;a.clearRect(0,0,canvas.width,canvas.height);a.fillStyle="black";a.fillRect(0,0,canvas.width,canvas.height);this.scene1.render(a);this.drawLogging(a)},fadeOut:function(a){a.globalAlpha=.5},nextScene:function(){this.scene1=new GameScene(this,this.sprites)},log:function(a){this.logInfo.push(a)},drawLogging:function(a){var b=this.logInfo,d=32;a.font="16px Arial bold";a.fillStyle=
"green";for(var c=0;c<b.length;c++)a.fillText(b[c],20,d),d+=16;this.logInfo=[]},update:function(){this.scene1.update(this.keys);this.glitchMode=this.scene1.glitchMode},run:function(a){stats.begin();Game.render();Game.update();stats.end();requestAnimationFrame(Game.run)}};function Sprite(a,b,d){this.height=this.width=9;this.x=a||50;this.y=b||50;this.vy=this.vx=0;this.speed=.5;this.img=0;this.gravity=!0;this.isOnGround=!1;this.col="red";this.type="sprite";this.isOnGround=!1}
Sprite.prototype={move:function(a){var b=this.vx,d=this.vy+.5;if(0<d){var c=d+this.y+this.height,e=this.x+this.width,g=a.collidingPoint(this.x,c),c=a.collidingPoint(e,c);g||c?(d=this.vy=0,this.isOnGround=!0):(this.vy=1,b=0)}if(0<b){if(g=this.x+b+this.width,e=this.y,c=this.y+this.height,e=a.collidingPoint(g,e),a=!a.collidingPoint(g,c+1),e||a)this.vx=b=-1*this.speed}else 0>b&&(g=this.x+b,e=this.y,c=this.y+this.height,e=a.collidingPoint(g,e),a=!a.collidingPoint(g,c+1),e||a)&&(this.vx=b=this.speed);this.x+=
b;this.y+=d}};function Arrow(a,b){this.x=a;this.y=b;this.vy=0;this.width=this.height=10;this.dir=-1}Arrow.prototype.move=function(a){0<this.dir?(this.vy+=.3,this.y+this.vy>this.y+4&&(this.dir*=-1)):(this.vy-=.3,this.y+this.vy<this.y-4&&(this.dir*=-1))};function World(a,b){this.size=14;this.height=this.width=a;this.collisionTiles=[]}
World.prototype={init:function(a){for(var b=this.size,d=[],c=0;c<b;c++){for(var e=[],g=0;g<b;g++){var h=a[c][g];h?(h=1===h?randomLetter():10>h?String.fromCharCode(48+h):h.toString(),e.push(h)):e.push(randomLetter())}d.push(e)}this.map=d;this.collisions=a},getTile:function(a,b){var d=this.width/this.size,c=a/d|0,e=b/d|0;return{t:this.map[e][c],x:c*d,y:e*d}},collidingPoint:function(a,b){var d=this.width,c=d/this.size;if(a>d-1||b>this.height-1||0>a||0>b)return!0;d=a/c|0;c=b/c|0;this.isSolid(d,c)&&this.collisionTiles.push({x:d,
y:c,type:this.map[c][d]});return this.isSolid(d,c)},isSolid:function(a,b){return 0!==this.collisions[b][a]&&50>this.collisions[b][a]}};function randomLetter(){var a=randi(16);return 10>a?String.fromCharCode(48+a):String.fromCharCode(87+a)};function KeyListeners(){var a={},b={},d={};[37,38,39,40,65,70,83].forEach(function(b){a[b]=!0});document.addEventListener("keyup",function(c){var e=c.keyCode;a[e]&&(b[e]=!1,d[e]=!0);c.preventDefault()});document.addEventListener("keydown",function(c){var e=c.keyCode;a[e]&&(b[e]=!0,d[e]=!1);c.preventDefault()});return{pressed:b,released:d,UP:38,DOWN:40,LEFT:37,RIGHT:39,F:70,A:65,S:83,anyPressed:function(){return 0<Object.keys(b).length}}};function Player(a,b){this.col="green";this.x=a;this.y=b;this.type="player";this.img=32;this.jumpTime=0;this.canJump=!1}Player.prototype=new Sprite;Player.prototype.move=function(){};var f=Images();f.load(function(a){Game.init("canvas",a);Game.run()});var stats=new Stats;stats.showPanel(0);document.body.appendChild(stats.dom);
